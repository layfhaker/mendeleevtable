# Анализ reactions.js — Ошибки и недостающие правила

## ЧАСТЬ 1: ОШИБКИ И БАГИ

### 1. Fe2O3 классифицируется и как basic, и как amphoteric_weak
В `substance_classes` Fe2O3 встречается дважды:
- `{ formula: "Fe2O3", class: "oxide", subclass: "basic" }`
- `{ formula: "Fe2O3", class: "oxide", subclass: "amphoteric_weak" }`

Последняя запись перезаписывает первую в `classMap`. Из-за этого `ruleBasicOxideAcid` может не сработать для Fe2O3, потому что функция проверяет `classifyFormula` → `kind: 'oxide'`, но подкласс будет `amphoteric_weak`, а не `basic`. Нужно решить — Fe2O3 в школьном курсе чаще считается основным оксидом (с кислотами реагирует как основный).

### 2. ruleMetalOxygen — Na + O2 → Na2O2
Строка 823: `if (metalStr === 'Na') return '2Na + O2 → Na2O2';`

Это верно для горения на воздухе, но если пользователь хочет именно Na2O, нужно условие "недостаток O2". К тому же для Li должен быть Li2O (Li — единственный щелочной, который даёт нормальный оксид при горении), а для K — KO2 (супероксид). Сейчас Li и K обрабатываются общим правилом через `metalToOxideMap`, что для Li правильно, но для K некорректно (K + O2 → KO2, а не K2O).

### 3. ruleHalogenAlkaliDisproportionation — ошибка в hot-формуле
Строка 1083: при нагревании Cl2 + NaOH даёт `NaClO3`, а не `NaClO`. Формула:
```
3Cl2 + 6NaOH → 5NaCl + NaClO3 + 3H2O
```
В коде: `${m}${halogen.replace('2', '')}O3` — это даст `NaClO3`, что верно для Cl.  
Но для Br2 и I2 эта реакция протекает иначе: Br2 и I2 при нагревании со щёлочью также диспропорционируют, но Br → BrO3⁻, а I → IO3⁻, что тоже `O3`. Формально код верный, но стоит проверить, что I2 + KOH(горяч.) действительно даёт KIO3.

### 4. ruleNeutralization — неправильный расчёт cationCharge
Строка 599: `const cationCharge = base.ohCount || getIonCharge(...)`.  
Здесь `ohCount` используется как заряд катиона, что верно только когда заряд = кол-ву OH. Для Ca(OH)2 `ohCount = 2`, `charge = 2` — совпадает. Но если бы была экзотическая запись, это может сломаться. Лучше всегда использовать `getIonCharge` и fallback на `ohCount`.

### 5. ruleMetalAcid — не расставлены коэффициенты
Строка 928: `return \`${metalStr} + ${acidStr} → ${salt} + H2↑\``  
Коэффициенты не расставлены (нет acid coeff, metal coeff, H2 coeff). Это полагается на `autoBalanceRuleEquation`, но для многих случаев brute force с maxCoeff=12 может не найти решение для сложных формул или работать медленно.

### 6. ruleHydrolysis — кислая соль строится неверно для многих случаев
Строки 1178-1179: `buildSaltFormula(salt.cationFormula, salt.cationCharge, \`H${salt.anionFormula}\`, salt.anionCharge + 1)`

Проблема: для Na2CO3 гидролиз даёт NaHCO3. Анион H(CO3) должен иметь заряд -1, а `salt.anionCharge + 1 = -2 + 1 = -1` — верно. Но формула `H${salt.anionFormula}` = `HCO3` — это корректно. Однако для Na2SO4 (сильная кислота) гидролиз не идёт — это должно отсечься раньше. А для Na3PO4 анион HPO4²⁻, не H(PO4). Формула `HPO4` с зарядом -2 — нужно проверить, что `buildSaltFormula` даст `Na2HPO4`, а не `NaHPO4`.

### 7. ruleAmphotericFusion — неполный map
Строка 1012-1017: map содержит Al2O3, ZnO, Al(OH)3, Cr2O3, но не содержит:
- Zn(OH)2 (при сплавлении → Na2ZnO2 + H2O)
- BeO, Be(OH)2 (при сплавлении → Na2BeO2 + H2O)
- PbO, Pb(OH)2
- SnO, Sn(OH)2

### 8. CrO3 → H2CrO4 / H2Cr2O7 — парсинг сломается
В `acid_oxide_pairs`: `{ oxide: "CrO3", acid: "H2CrO4 / H2Cr2O7" }`.  
`parseAcid("H2CrO4 / H2Cr2O7")` вернёт null или неверный результат из-за пробелов и слеша.

### 9. metalToOxideMap — ключ для Fe
В `metal_oxide_pairs` есть `metal: "Fe(II)"` и `metal: "Fe(III)"`. Код делает `pair.metal.replace(/\(.*\)$/, '')` → `"Fe"` для обоих. Второй (Fe2O3) перезапишет первый (FeO) в `metalToOxideMap`. Значит `metalToOxideMap.get('Fe')` = `Fe2O3`, а не `FeO`. Это влияет на `ruleDecompositionCarbonates` (FeCO3 обработан hardcoded) и `ruleDecompositionNitrates` (Fe(NO3)2 даст Fe2O3 вместо FeO).

### 10. Дублирование хэндлеров в applyRules
R28 и R36 оба вызывают `ruleKMnO4`. R29/R29B и R37/R38 оба вызывают `ruleK2Cr2O7`/`ruleK2Cr2O7FeSO4`. Это не баг, но лишние вызовы — если первый не матчит, второй тоже не матчит.

---

## ЧАСТЬ 2: НЕДОСТАЮЩИЕ ПРАВИЛА / РЕАКЦИИ

### A. Химия кремния (SiO2)
- **SiO2 + NaOH(сплавл.)** → Na2SiO3 + H2O ✗ (не покрыто — `ruleAcidicOxideBase` требует `strong` base, но `SiO2` отдельно не обработан для сплавления)
- **SiO2 + Na2CO3(сплавл.)** → Na2SiO3 + CO2↑ ✗
- **SiO2 + CaO(сплавл.)** → CaSiO3 ✗
- **SiO2 + HF** → SiF4↑ + 2H2O ✗ (уникальная реакция кремнезёма)
- **Si + NaOH + H2O** → Na2SiO3 + H2↑ ✗
- **Na2SiO3 + CO2 + H2O** → Na2CO3 + H2SiO3↓ ✗ (вытеснение слабой кислоты)

### B. Сульфиды
- **FeS + HCl** → FeCl2 + H2S↑ ✗ (в общем ruleSaltAcid есть, но FeS не факт, что корректно парсится как "соль")
- **Na2S + HCl** → 2NaCl + H2S↑ ✗ (должно работать через ruleSaltAcid, но нужно проверить)
- **CuS + HNO3(конц)** → Cu(NO3)2 + S + ... ✗ (нерастворимые сульфиды + окислитель)
- **FeS2 (пирит)** — горение: 4FeS2 + 11O2 → 2Fe2O3 + 8SO2 ✗
- **PbS + HNO3** ✗

### C. Фосфор
- **P + O2** — сейчас `ruleNonmetalOxygen` берёт первый оксид из oxideToAcidMap (P2O5), что верно только для избытка O2. При недостатке → P2O3.
- **P + Cl2** → PCl3 (недост.) / PCl5 (избыток) ✗
- **P + металлы** → фосфиды (Ca3P2, Na3P) ✗
- **PCl3 + H2O** → H3PO3 + HCl ✗
- **PCl5 + H2O** → H3PO4 + HCl ✗

### D. Азот и аммиак (расширение)
- **NH4Cl** разложение при нагревании: NH4Cl → NH3↑ + HCl↑ ✗
- **(NH4)2Cr2O7** разложение: (NH4)2Cr2O7 → Cr2O3 + N2↑ + 4H2O ✗ (вулканчик)
- **NH4HCO3** разложение: NH4HCO3 → NH3↑ + CO2↑ + H2O ✗
- **NH4NO3** при нагревании (есть, но только один вариант). При сильном нагревании: 2NH4NO3 → 2N2↑ + O2↑ + 4H2O ✗
- **N2 + H2** → NH3 (синтез аммиака) ✗
- **N2 + металлы** → нитриды (Li3N, Ca3N2, Mg3N2) ✗
- **NH3 + CuO** → Cu + N2 + H2O ✗

### E. Углерод
- **C + H2O(пар)** → CO + H2 (водяной газ) ✗
- **CO + NaOH(конц, давление)** → HCOONa ✗ (специфично, но встречается в ЕГЭ)
- **CO2 + C** → 2CO (реакция Будуара) ✗
- **CO2 + Mg** → MgO + C (горение магния в CO2) ✗

### F. Сера
- **S + металлы** → сульфиды (Fe + S → FeS, Cu + S → CuS, Na + S → Na2S и др.) ✗
- **S + O2** → SO2 (уже есть через ruleNonmetalOxygen? надо проверить)
- **SO2 + H2O** — покрыто через ruleAcidicOxideWater ✓
- **SO3 + H2O** — покрыто ✓
- **SO2 + H2S** → S + H2O (ОВР) ✗
- **SO2 + NaOH** → Na2SO3 + H2O / NaHSO3 (избыток SO2) ✗ (через ruleAcidicOxideBase есть первая, но нет второй)
- **H2SO4(конц) + NaCl(тв)** → NaHSO4 + HCl↑ ✗ (получение HCl в лаборатории)
- **H2SO4(конц) + NaNO3(тв)** → NaHSO4 + HNO3↑ ✗ (получение HNO3 в лаборатории)
- **H2SO4(конц) + сахароза** — есть в ruleDehydration ✓

### G. Галогены (расширение)
- **F2 + H2O** → HF + OF2 / HF + O2 ✗ (фтор — особый случай, не просто HF + HFO)
- **HF + SiO2** → SiF4 + H2O ✗
- **HCl + MnO2** → MnCl2 + Cl2 + H2O ✗ (получение хлора в лаборатории)
- **Cl2 + Fe** → FeCl3 (есть в ruleSpecialCombination ✓)
- **I2 + крахмал** — качественная, не уравнение

### H. Металлы — дополнительные ОВР
- **Fe + H2O(пар)** — есть в ruleMetalSteam ✓
- **Fe(OH)2 + O2 + H2O** → Fe(OH)3 ✗ (окисление на воздухе)
- **Fe2O3 + H2** → Fe + H2O ✗ (восстановление водородом)
- **CuO + H2** → Cu + H2O ✗ (восстановление водородом)
- **WO3 + H2** → W + H2O ✗
- Другие оксиды + H2 ✗
- **Cu + конц. HNO3** — покрыто через ruleMetalHNO3 ✓
- **Cu + разб. HNO3** — покрыто ✓
- **3Cu + 8HNO3(разб)** — нужно проверить коэффициенты

### I. Электролиз (серьёзно расширить)
Сейчас электролиз покрыт только hardcoded для NaCl, AgNO3, KBr, Al2O3, NaOH, MgCl2, CuSO4, H2O. Нужно добавить:
- **Раствор**: общее правило по катоду (ряд активности) и аноду (тип аниона)
- Расплав солей активных металлов с кислородсодержащими анионами
- Расплав гидроксидов
- электролиз Cu(NO3)2, FeCl2, NiBr2 и др.

### J. Термолиз (разложение при нагревании)
- **Сульфаты**: FeSO4 → Fe2O3 + SO2 + SO3 ✗ (сложные продукты)
- **Сульфиты**: Na2SO3 → Na2SO4 + Na2S ✗ (диспропорционирование)
- **Хлораты**: KClO3 → KCl + O2 (есть ✓), но KClO3 + MnO2(кат) → KCl + O2 ✗
- **Оксалаты, ацетаты** (органика — может быть вне scope)
- **CaCO3** → CaO + CO2 — покрыто через ruleDecompositionCarbonates ✓
- **Cu(OH)2** → CuO + H2O — покрыто через ruleDecompositionHydroxides ✓
- **NH4Cl** → NH3 + HCl ✗
- **NH4HCO3** → NH3 + CO2 + H2O ✗
- **KNO2** разложение ✗

### K. Комплексные соединения (расширить)
Сейчас только Cu(OH)2 + NH3 и AgCl + NH3. Нужно:
- **Fe(OH)3 + 3HCl** → FeCl3 + 3H2O (не комплекс, но часто путают)
- **FeCl3 + KSCN** → Fe(SCN)3 + KCl (качественная на Fe³⁺) ✗
- **FeCl3 + K4[Fe(CN)6]** → KFe[Fe(CN)6]↓ + KCl (берлинская лазурь) ✗
- **FeCl2 + K3[Fe(CN)6]** → KFe[Fe(CN)6]↓ + KCl (турнбулева синь) ✗
- **AgNO3 + NH3 → [Ag(NH3)2]NO3** ✗
- **CuSO4 + NaOH(изб)** — сначала Cu(OH)2↓, потом не растворяется (амфотерность Cu слабая)
- **Zn(OH)2 + NH3** → [Zn(NH3)4](OH)2 ✗
- **AlCl3 + NaOH(изб.)** → Na[Al(OH)4] / NaAlO2 + NaCl + H2O ✗ (поэтапное добавление щёлочи к соли)

### L. Качественные реакции (уравнения)
- **Ca(OH)2 + CO2** → CaCO3↓ + H2O (помутнение известковой воды) ✗
- **Ca(OH)2 + CO2(изб)** → Ca(HCO3)2 (просветление) ✗
- **BaCl2 + Na2SO4** → BaSO4↓ + 2NaCl — покрыто через ruleSaltSalt ✓
- **AgNO3 + NaCl** → AgCl↓ + NaNO3 — покрыто через ruleSaltSalt ✓

### M. Общие структурные пробелы
1. **Нет правила: неметалл + неметалл** (H2 + Cl2 → 2HCl, H2 + S → H2S, H2 + N2 → NH3 и т.д.)
2. **Нет правила: металл + неметалл** (кроме O2 и галогенов) — Fe + S, Na + S, Ca + N2, и др.
3. **Нет правила: оксид + восстановитель H2** (только CO и C есть)
4. **Нет правила: SiO2 + специфика** (плавка с основаниями, с HF)
5. **Нет правила: разложение солей аммония** (NH4Cl, NH4HCO3, (NH4)2CO3, (NH4)2Cr2O7)
6. **Нет правила: окисление Fe²⁺ → Fe³⁺** (FeCl2 + Cl2 → FeCl3, Fe(OH)2 → Fe(OH)3)
7. **Нет общего правила для электролиза по таблице** (сейчас только hardcoded)

---

## ЧАСТЬ 3: ПРИОРИТЕТ ДОБАВЛЕНИЯ

По важности для ЕГЭ/ОГЭ:

**Высокий приоритет (часто в заданиях):**
1. Неметалл + неметалл (H2+Cl2, H2+S, N2+H2)
2. Металл + неметалл (Fe+S, Na+S, Ca+N2)
3. Восстановление H2 (CuO+H2, Fe2O3+H2)
4. SiO2 + NaOH(сплавл), SiO2 + HF
5. Разложение солей аммония
6. Окисление Fe²⁺ → Fe³⁺ (Cl2, O2)
7. Ca(OH)2 + CO2 (качественная!)
8. Получение HCl/HNO3 (H2SO4конц + NaCl/NaNO3)
9. Fe(OH)2 + O2 + H2O → Fe(OH)3
10. N2 + H2 → NH3

**Средний приоритет:**
11. Электролиз расширенный
12. Химия фосфора (P+Cl2, PCl+H2O)
13. SO2 + H2S → S + H2O
14. CO2 + C → 2CO
15. CO2 + Mg → MgO + C
16. Качественные ОВР (FeCl3+KSCN, берлинская лазурь)

**Низкий приоритет (редко):**
17. Пирит FeS2 + O2
18. CO + NaOH → HCOONa
19. Водяной газ C + H2O → CO + H2
20. Экзотические комплексы
